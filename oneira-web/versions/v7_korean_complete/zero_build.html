<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Oneira: 2026 Daily Fortune</title>

    <!-- 1. Tailwind & Config -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    fontFamily: { sans: ["Manrope", "sans-serif"], serif: ["Tenor Sans", "serif"] },
                    colors: { background: "#150910", surface: "#230f19", primary: "#ff0084", "primary-dark": "#cc006a", "accent-pink": "#ce8dae", "cosmic-purple": "#8b5cf6", "cosmic-cyan": "#06b6d4" },
                    animation: { "pulse-slow": "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite", "spin-slow": "spin 12s linear infinite", "fade-in": "fadeIn 0.5s ease-out forwards" },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } },
                    backgroundImage: { 'noise': "url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMDI1Ii8+Cjwvc3ZnPg==')" }
                },
            },
        };
    </script>

    <!-- 2. Fonts & Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Tenor+Sans&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- 3. React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"
        crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin></script>

    <!-- 4. Global CSS -->
    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 0, 132, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 0, 132, 0.5);
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
        }

        .glass-panel {
            background: rgba(35, 15, 25, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>

<body class="bg-background text-white antialiased overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // --- CONSTANTS ---
        const ViewState = { SPLASH: 'SPLASH', SELECTION: 'SELECTION', USER_INFO: 'USER_INFO', INPUT_DREAM: 'INPUT_DREAM', LOADING: 'LOADING', RESULT: 'RESULT', HISTORY: 'HISTORY' };
        const FortuneType = { DREAM: 'DREAM', ORACLE: 'ORACLE', SOUL: 'SOUL' };

        // --- COMPONENTS ---

        const Background = () => (
            <div className="absolute inset-0 z-0 pointer-events-none overflow-hidden select-none">
                <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-primary/10 rounded-full blur-[120px]" />
                <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-cosmic-purple/10 rounded-full blur-[120px]" />
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-primary/5 rounded-full blur-[100px] opacity-40" />
                <div className="absolute inset-0 bg-noise opacity-20 mix-blend-overlay" />
            </div>
        );

        const Header = ({ title, showBack, onBack }) => (
            <header className="flex items-center justify-between px-6 py-6 sticky top-0 z-30 shrink-0">
                <div className="flex items-center gap-3">
                    {showBack ? (
                        <button onClick={onBack} className="group flex items-center justify-center rounded-full h-10 pr-4 pl-3 bg-white/5 hover:bg-white/10 text-white/80 hover:text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] transition-all duration-300">
                            <span className="material-symbols-outlined text-[20px] transition-transform group-hover:-translate-x-1">arrow_back</span>
                            <span className="truncate">RETURN</span>
                        </button>
                    ) : (
                        <>
                            <div className="size-8 flex items-center justify-center rounded-full bg-primary/10 text-primary ring-1 ring-primary/30">
                                <span className="material-symbols-outlined text-[20px]">auto_awesome</span>
                            </div>
                            <h2 className="text-white text-xl font-serif font-bold tracking-tight">{title}</h2>
                        </>
                    )}
                </div>
            </header>
        );

        const SplashView = ({ onEnter }) => (
            <div className="flex flex-col items-center justify-center h-full w-full space-y-16 animate-fade-in px-6">
                <div className="flex items-center justify-center gap-8 md:gap-12">
                    <div className="w-16 h-16 rounded-full bg-white/5 border border-white/10 flex items-center justify-center backdrop-blur-md">
                        <span className="material-symbols-outlined text-3xl text-white/90">dark_mode</span>
                    </div>
                    <div onClick={onEnter} className="cursor-pointer group relative w-24 h-24 rounded-full bg-white/10 border border-white/20 flex items-center justify-center backdrop-blur-xl transition-all duration-500 hover:scale-110 hover:shadow-[0_0_50px_rgba(255,0,132,0.5)]">
                        <span className="material-symbols-outlined text-5xl text-primary drop-shadow-[0_0_8px_rgba(255,0,132,0.8)] group-hover:rotate-12 transition-transform duration-500">auto_awesome</span>
                        <div className="absolute inset-0 rounded-full border border-primary/30 animate-pulse-slow"></div>
                    </div>
                    <div className="w-16 h-16 rounded-full bg-white/5 border border-white/10 flex items-center justify-center backdrop-blur-md">
                        <span className="material-symbols-outlined text-3xl text-white/90">blur_on</span>
                    </div>
                </div>

                <div className="flex flex-col items-center text-center space-y-6">
                    <h1 className="font-serif text-5xl font-normal leading-tight tracking-[0.2em] text-white drop-shadow-xl">
                        2026<br />DAILY<br />DESTINY
                    </h1>
                    <div className="w-px h-12 bg-gradient-to-b from-transparent via-primary/50 to-transparent"></div>
                </div>

                <button onClick={onEnter} className="mt-8 text-accent-pink text-xs font-bold tracking-[0.3em] uppercase opacity-70 hover:opacity-100 transition-opacity">
                    Tap the spark to begin
                </button>
            </div>
        );

        const SelectionView = ({ onSelect, onHistory }) => (
            <div className="flex flex-col h-full w-full animate-fade-in pb-24">
                <Header title="Oneira" />
                <div className="flex-1 overflow-y-auto px-6 pt-2 pb-6">
                    <div className="flex flex-col mb-8 text-center">
                        <h1 className="text-3xl font-serif text-white leading-tight mb-2">
                            2026<br />
                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-primary to-cosmic-purple">DAILY DESTINY</span>
                        </h1>
                        <p className="text-white/60 text-sm font-medium">운명을 확인할 길을 선택하세요.</p>
                    </div>

                    <div className="flex flex-col sm:flex-row justify-center items-stretch gap-3 w-full min-h-[420px]">
                        {/* 1. DREAM */}
                        <div onClick={() => onSelect(FortuneType.DREAM)} className="group relative flex-1 cursor-pointer transition-all duration-500 hover:flex-[1.2] hover:-translate-y-2">
                            <div className="relative h-full w-full rounded-[1.5rem] border border-cosmic-purple/50 bg-[#0a0510] shadow-[0_0_15px_rgba(139,92,246,0.1)] group-hover:shadow-[0_0_30px_rgba(139,92,246,0.4)] group-hover:border-cosmic-purple transition-all duration-300 overflow-hidden flex flex-col items-center justify-center">
                                <div className="absolute inset-0 bg-gradient-to-b from-transparent via-cosmic-purple/5 to-cosmic-purple/10 opacity-50"></div>
                                <div className="w-20 h-20 rounded-full border-2 border-cosmic-purple/80 shadow-[0_0_15px_rgba(139,92,246,0.5)] flex items-center justify-center bg-cosmic-purple/5 mb-4">
                                    <span className="material-symbols-outlined text-cosmic-purple text-4xl">mode_night</span>
                                </div>
                                <div className="text-center relative z-10">
                                    <p className="text-cosmic-purple text-xs font-bold tracking-[0.15em] uppercase">해몽</p>
                                    <p className="text-[9px] text-white/30 font-mono mt-1">THE MOON</p>
                                </div>
                            </div>
                        </div>

                        {/* 2. ORACLE */}
                        <div onClick={() => onSelect(FortuneType.ORACLE)} className="group relative flex-1 cursor-pointer transition-all duration-500 hover:flex-[1.2] hover:-translate-y-2">
                            <div className="relative h-full w-full rounded-[1.5rem] border border-cosmic-cyan/50 bg-[#050a10] shadow-[0_0_15px_rgba(6,182,212,0.1)] group-hover:shadow-[0_0_30px_rgba(6,182,212,0.4)] group-hover:border-cosmic-cyan transition-all duration-300 overflow-hidden flex flex-col items-center justify-center">
                                <div className="absolute inset-0 bg-gradient-to-b from-transparent via-cosmic-cyan/5 to-cosmic-cyan/10 opacity-50"></div>
                                <div className="w-20 h-32 border border-cosmic-cyan/60 flex items-center justify-center bg-cosmic-cyan/5 mb-4">
                                    <span className="material-symbols-outlined text-cosmic-cyan text-5xl">visibility</span>
                                </div>
                                <div className="text-center relative z-10">
                                    <p className="text-cosmic-cyan text-xs font-bold tracking-[0.15em] uppercase">운세</p>
                                    <p className="text-[9px] text-white/30 font-mono mt-1">THE MAGICIAN</p>
                                </div>
                            </div>
                        </div>

                        {/* 3. SOUL (Added back) */}
                        <div onClick={() => onSelect(FortuneType.SOUL)} className="group relative flex-1 cursor-pointer transition-all duration-500 hover:flex-[1.2] hover:-translate-y-2">
                            <div className="relative h-full w-full rounded-[1.5rem] border border-primary/50 bg-[#10050a] shadow-[0_0_15px_rgba(255,0,132,0.1)] group-hover:shadow-[0_0_30px_rgba(255,0,132,0.4)] group-hover:border-primary transition-all duration-300 overflow-hidden flex flex-col items-center justify-center">
                                <div className="absolute inset-0 bg-gradient-to-b from-transparent via-primary/5 to-primary/10 opacity-50"></div>
                                <div className="flex items-center justify-center relative p-2 mb-4">
                                    <span className="material-symbols-outlined text-primary text-5xl drop-shadow-[0_0_8px_rgba(255,0,132,0.8)]">favorite</span>
                                </div>
                                <div className="text-center relative z-10">
                                    <div className="w-8 h-px bg-primary/50 mx-auto mb-3"></div>
                                    <p className="text-primary text-xs font-bold tracking-[0.15em] uppercase group-hover:text-white transition-colors">심리</p>
                                    <p className="text-[9px] text-white/30 font-mono mt-1">THE LOVERS</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* COLLECTION BUTTON (New) */}
                    <div className="mt-8 w-full flex justify-center">
                        <button onClick={onHistory} className="group flex items-center gap-3 px-8 py-4 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 hover:border-primary/50 transition-all">
                            <span className="material-symbols-outlined text-white/70 group-hover:text-primary transition-colors">collections</span>
                            <span className="text-sm font-serif font-bold tracking-widest text-white/90 group-hover:text-white">나의 수집함</span>
                        </button>
                    </div>

                </div>
            </div>
        );

        const UserInfoView = ({ onBack, onNext }) => {
            const [name, setName] = useState('');
            const [birth, setBirth] = useState('');
            const [gender, setGender] = useState('unknown');

            const isFormValid = name.trim().length > 0 && birth.length > 0;

            return (
                <div className="flex flex-col h-full w-full animate-fade-in relative z-20">
                    <Header title="IDENTITY" showBack onBack={onBack} />
                    <div className="flex-1 flex flex-col px-8 pt-4 gap-8 overflow-y-auto">
                        <div>
                            <label className="block text-accent-pink text-xs tracking-widest uppercase mb-3">이름</label>
                            <input
                                type="text"
                                value={name} onChange={(e) => setName(e.target.value)}
                                className="w-full bg-white/5 border-b border-white/20 p-4 text-xl text-white focus:border-primary focus:outline-none transition-colors font-serif"
                                placeholder="이름을 입력하세요"
                            />
                        </div>
                        <div>
                            <label className="block text-accent-pink text-xs tracking-widest uppercase mb-3">생년월일</label>
                            <input
                                type="date"
                                value={birth} onChange={(e) => setBirth(e.target.value)}
                                className="w-full bg-white/5 border-b border-white/20 p-4 text-xl text-white focus:border-primary focus:outline-none transition-colors font-serif"
                            />
                        </div>
                        <div>
                            <label className="block text-accent-pink text-xs tracking-widest uppercase mb-3">성별</label>
                            <div className="flex gap-4">
                                {['남성', '여성', '비공개'].map((g) => (
                                    <button
                                        key={g}
                                        onClick={() => setGender(g)}
                                        className={`flex-1 py-4 rounded-xl border ${gender === g ? 'border-primary bg-primary/20 text-white' : 'border-white/10 bg-white/5 text-white/40'} transition-all`}
                                    >
                                        {g}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="p-8 pb-10">
                        <button
                            onClick={() => onNext({ name, birth, gender })}
                            disabled={!isFormValid}
                            className="w-full rounded-full h-14 bg-white/10 hover:bg-white/20 disabled:opacity-30 text-white font-bold tracking-[0.1em] border border-white/20 transition-all flex items-center justify-center gap-2"
                        >
                            <span>계속하기</span>
                            <span className="material-symbols-outlined">arrow_forward</span>
                        </button>
                    </div>
                </div>
            )
        };

        const HistoryView = ({ history, onBack, onSelect }) => (
            <div className="flex flex-col h-full w-full animate-fade-in pb-24">
                <Header title="Collection" showBack onBack={onBack} />
                <div className="px-6 pt-2 pb-6 flex-1 overflow-y-auto">
                    <div className="mb-6">
                        <h2 className="text-white text-3xl font-serif font-bold leading-tight">Your Path</h2>
                        <p className="text-accent-pink text-sm font-normal opacity-80">Fragments of your destiny.</p>
                    </div>

                    {history.length === 0 ? (
                        <div className="flex flex-col items-center justify-center h-64 opacity-50 border border-dashed border-white/20 rounded-2xl">
                            <span className="material-symbols-outlined text-4xl mb-2">auto_awesome_mosaic</span>
                            <p className="text-sm">아직 수집된 운세가 없습니다.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-4">
                            {history.map((item, i) => (
                                <div key={i} onClick={() => onSelect(item)} className="group relative flex flex-col bg-[#2e1423] rounded-[2rem] p-3 border border-white/5 overflow-hidden hover:border-primary/50 transition-all cursor-pointer">
                                    {/* Image Thumbnail */}
                                    <div className="aspect-[2/3] w-full rounded-2xl bg-black mb-3 overflow-hidden relative">
                                        <img
                                            src={item.imageUrl || `https://picsum.photos/seed/${item.id || 999}/800/1200?grayscale&blur=2`}
                                            className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                                            alt="Fortune"
                                            onError={(e) => {
                                                if (!e.currentTarget.src.includes('picsum')) {
                                                    const seed = item.id ? item.id : 999;
                                                    e.currentTarget.src = `https://picsum.photos/seed/${seed}/800/1200?grayscale&blur=2`;
                                                }
                                            }}
                                        />
                                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                        <div className="absolute bottom-2 left-2 flex items-center gap-1">
                                            <span className="material-symbols-outlined text-white text-sm">{item.icon}</span>
                                            <span className="text-[10px] text-white/80 font-bold">{item.title}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <p className="text-accent-pink text-[10px] font-medium uppercase tracking-wider mb-1">{item.date}</p>
                                        <p className="text-white/60 text-xs line-clamp-2">{item.description.split('\n')[0]}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );

        const InputDreamView = ({ onBack, onSubmit, type }) => {
            const [text, setText] = useState("");
            return (
                <div className="flex flex-col h-full w-full animate-fade-in relative z-20">
                    <Header title="" showBack onBack={onBack} />
                    <div className="flex-1 flex flex-col px-8 overflow-y-auto">
                        <div className="pt-4 pb-6">
                            <h2 className="font-serif text-white tracking-wide text-3xl font-normal leading-tight text-left">
                                {type === FortuneType.DREAM ? "어떤 꿈을 꾸셨나요?" : "무엇이 궁금하신가요?"}
                            </h2>
                        </div>
                        <div className="flex-1 flex flex-col pb-[120px]">
                            <textarea
                                autoFocus
                                value={text}
                                onChange={(e) => setText(e.target.value)}
                                className="w-full h-full min-h-[300px] bg-transparent border-none text-[22px] text-white/90 font-serif placeholder:text-accent-pink/40 leading-relaxed outline-none resize-none"
                                placeholder={type === FortuneType.DREAM ? "꿈의 내용을 자세히 들려주세요..." : "마음을 집중하고 질문을 생각해보세요..."}
                            />
                        </div>
                    </div>
                    <div className="absolute bottom-0 left-0 w-full p-8 bg-gradient-to-t from-background via-background to-transparent z-20">
                        <button onClick={() => onSubmit(text)} disabled={!text.trim()} className="w-full rounded-full h-14 bg-primary hover:bg-primary-dark disabled:opacity-50 text-white font-bold tracking-[0.05em] shadow-[0_0_25px_rgba(255,0,132,0.25)] flex items-center justify-center gap-3 transition-all">
                            <span className="material-symbols-outlined text-[20px] animate-pulse-slow">auto_awesome</span>
                            <span>INTERPRET</span>
                        </button>
                    </div>
                </div>
            );
        };

        const LoadingView = () => (
            <div className="flex flex-col items-center justify-center h-full w-full z-50 bg-background/80 backdrop-blur-xl">
                <div className="relative size-24 flex items-center justify-center">
                    <div className="absolute inset-0 rounded-full border-2 border-primary/20"></div>
                    <div className="absolute inset-0 rounded-full border-t-2 border-primary animate-spin"></div>
                    <span className="material-symbols-outlined text-4xl text-primary animate-pulse">auto_awesome</span>
                </div>
                <p className="mt-8 text-white/60 font-serif tracking-widest text-sm animate-pulse">별들의 이야기를 읽고 있습니다...</p>
            </div>
        );

        const ResultView = ({ result, onAccept }) => {
            if (!result) return null;

            // Robust Parsing: Handle **, [], and various spacings
            // Looks for "4." followed by anything until "프롬프트" or "Prompt" then capture the rest
            const promptRegex = /4\.\s*(?:\*\*|\[)?\s*(?:이미지\s*프롬프트|Image\s*Prompt)\s*(?:\*\*|\])?\s*:?\s*(.*)/i;
            const promptMatch = result.description.match(promptRegex);

            // Fix 502 Error: Truncate prompt to safe length (150 chars) and use 'turbo' model
            let imagePrompt = promptMatch ? promptMatch[1].trim() : "Mystic tarot card, ethereal light";
            if (imagePrompt.length > 150) imagePrompt = imagePrompt.substring(0, 150);

            // URL handling:
            // 1. If result has a saved imageUrl (from History), use it.
            // 2. If not, generate a new one based on the prompt.
            // We use useState to hold the URL so it doesn't regenerate on internal re-renders.
            const [finalImageUrl] = useState(() => {
                return result.imageUrl || `https://image.pollinations.ai/prompt/${encodeURIComponent(imagePrompt)}?width=800&height=1200&seed=${Math.random()}&nologo=true&model=turbo`;
            });

            // Clean Description: Remove the "4. ..." part
            let cleanDescription = result.description;
            const splitMatch = result.description.match(/4\.\s*(?:\*\*|\[)?\s*이미지/i);
            if (splitMatch) {
                cleanDescription = result.description.substring(0, splitMatch.index).trim();
            }

            return (
                <div className="flex flex-col items-center h-full w-full z-40 bg-background relative overflow-hidden animate-fade-in px-6 text-center">
                    {/* Background Blur Effect */}
                    <div className="absolute inset-0 z-0 bg-cover bg-center opacity-30 blur-xl scale-110 transition-opacity duration-1000" style={{ backgroundImage: `url('${finalImageUrl}')` }}></div>
                    <div className="absolute inset-0 z-0 bg-gradient-to-b from-background/90 via-background/95 to-background"></div>

                    <div className="relative z-10 flex flex-col items-center w-full max-w-lg overflow-y-auto max-h-screen py-10 no-scrollbar">

                        {/* THE DRAWN IMAGE (Central Hero) with Loading State */}
                        <div className="group relative mb-8 flex flex-col items-center justify-center shrink-0">
                            <div className="relative w-64 h-96 rounded-2xl overflow-hidden border border-white/20 shadow-[0_0_50px_rgba(139,92,246,0.25)] group-hover:shadow-[0_0_80px_rgba(255,0,132,0.4)] transition-all duration-700 bg-black flex items-center justify-center">
                                {/* Always show spinner if image hasn't loaded */}
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <span className="material-symbols-outlined text-4xl text-white/20 animate-spin">progress_activity</span>
                                </div>

                                <img
                                    src={finalImageUrl} alt="Destiny Card"
                                    className="relative w-full h-full object-cover z-10"
                                    style={{ minHeight: '100%' }}
                                    loading="eager"
                                    onError={(e) => {
                                        // Fallback to Picsum (Reliable) if Pollinations (Unstable) fails
                                        // Use DETERMINISTIC seed based on the UNIQUE RESULT ID so it's unique per fortune but stable on re-view
                                        if (!e.currentTarget.src.includes('picsum')) {
                                            console.warn("Pollinations failed, switching to Picsum fallback");
                                            const seed = result.id ? result.id : 999;
                                            e.currentTarget.src = `https://picsum.photos/seed/${seed}/800/1200?grayscale&blur=2`;
                                        }
                                    }}
                                />

                                {/* Shine effect */}
                                <div className="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none z-20"></div>
                            </div>
                            <p className="mt-4 text-[10px] text-white/40 tracking-[0.3em] font-serif uppercase animate-pulse">Your Vision</p>
                        </div>

                        <div className="mb-8 flex flex-col items-center gap-2 shrink-0">
                            <h2 className="text-sm font-bold tracking-[0.2em] text-white/60 uppercase">DESTINY REVEALED</h2>
                            <h1 className="font-serif text-5xl font-normal tracking-wider text-white drop-shadow-xl uppercase">{result.title}</h1>
                        </div>

                        <div className="mb-14 px-4 shrink-0">
                            <p className="text-lg font-light leading-relaxed text-white/80 antialiased font-serif whitespace-pre-wrap">
                                {cleanDescription}
                            </p>
                        </div>

                        <button onClick={onAccept} className="group relative flex min-w-[200px] items-center justify-center overflow-hidden rounded-full border border-white/30 bg-white/5 px-8 py-4 transition-all duration-300 hover:border-primary hover:bg-primary/20 hover:shadow-[0_0_20px_rgba(255,0,132,0.4)] active:scale-95 shrink-0 backdrop-blur-md">
                            <span className="font-bold tracking-[0.15em] text-white">확인</span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState(ViewState.SPLASH);
            const [selectedType, setSelectedType] = useState(null);
            const [userInfo, setUserInfo] = useState(null); // Store User Info
            const [result, setResult] = useState(null);
            // Load history from localStorage if available
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('dream_history');
                return saved ? JSON.parse(saved) : [];
            });

            // Save history to localStorage whenever it changes
            useEffect(() => {
                localStorage.setItem('dream_history', JSON.stringify(history));
            }, [history]);

            const processFortune = async (type, context) => {
                setView(ViewState.LOADING);
                try {
                    // Construct enhanced context
                    const userContextStr = `Name: ${userInfo?.name || 'Unknown'}, Birth: ${userInfo?.birth || 'Unknown'}, Gender: ${userInfo?.gender || 'Unknown'}. Content: ${context}`;

                    const res = await fetch('http://127.0.0.1:8000/analyze_dream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: type, user_context: userContextStr })
                    });
                    if (res.ok) {
                        const data = await res.json();

                        // Parse Image Prompt for URL generation
                        const promptRegex = /4\.\s*(?:\*\*|\[)?\s*(?:이미지\s*프롬프트|Image\s*Prompt)\s*(?:\*\*|\])?\s*:?\s*(.*)/i;
                        const promptMatch = data.interpretation.match(promptRegex);
                        let imagePrompt = promptMatch ? promptMatch[1].trim() : "Mystic tarot card, ethereal light";
                        if (imagePrompt.length > 150) imagePrompt = imagePrompt.substring(0, 150);
                        const generatedImageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(imagePrompt)}?width=800&height=1200&seed=${Math.random()}&nologo=true&model=turbo`;

                        const newResult = {
                            id: Date.now(), // Unique ID for finding this item and seeding random images
                            title: data.luck_score.toString(),
                            description: data.interpretation,
                            icon: type === FortuneType.DREAM ? 'mode_night' : type === FortuneType.ORACLE ? 'visibility' : 'favorite',
                            date: new Date().toLocaleDateString(),
                            imageUrl: generatedImageUrl // Save the specific image URL
                        };
                        setResult(newResult);
                        setHistory(prev => [newResult, ...prev]);
                    } else throw new Error();
                } catch {
                    const fallbackUrl = "https://image.pollinations.ai/prompt/Mystical%20Fog,%20dreamy%20atmosphere,%20purple%20and%20blue%20light,%20tarot%20style?width=800&height=1200&nologo=true&model=turbo";
                    const fallback = {
                        id: Date.now(),
                        title: "88",
                        description: "1. 요약\n우주는 당신의 편입니다.\n\n2. 심층\n잠시 쉬어가는 시간입니다.\n\n3. 조언\n마음의 평화를 찾으세요.\n\n4. [이미지 프롬프트]: Mystical Fog",
                        icon: 'error',
                        date: new Date().toLocaleDateString(),
                        imageUrl: fallbackUrl
                    };
                    setResult(fallback);
                    setHistory(prev => [fallback, ...prev]);
                }
                setView(ViewState.RESULT);
            };

            return (
                <div className="relative w-full h-screen bg-background text-white flex justify-center overflow-hidden">
                    <Background />
                    <div className="relative w-full max-w-[600px] h-full bg-background/50 backdrop-blur-sm shadow-2xl border-x border-white/5 overflow-hidden flex flex-col">
                        {view === ViewState.SPLASH && <SplashView onEnter={() => setView(ViewState.SELECTION)} />}

                        {view === ViewState.SELECTION && <SelectionView
                            onSelect={(t) => { setSelectedType(t); setView(ViewState.USER_INFO); }}
                            onHistory={() => setView(ViewState.HISTORY)}
                        />}

                        {view === ViewState.USER_INFO && <UserInfoView
                            onBack={() => setView(ViewState.SELECTION)}
                            onNext={(info) => { setUserInfo(info); setView(ViewState.INPUT_DREAM); }}
                        />}

                        {view === ViewState.INPUT_DREAM && <InputDreamView
                            type={selectedType}
                            onBack={() => setView(ViewState.SELECTION)}
                            onSubmit={(txt) => processFortune(selectedType, txt)}
                        />}

                        {view === ViewState.LOADING && <LoadingView />}

                        {view === ViewState.RESULT && <ResultView result={result} onAccept={() => setView(ViewState.HISTORY)} />}

                        {view === ViewState.HISTORY && <HistoryView
                            history={history}
                            onBack={() => setView(ViewState.SELECTION)}
                            onSelect={(savedItem) => { setResult(savedItem); setView(ViewState.RESULT); }}
                        />}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>