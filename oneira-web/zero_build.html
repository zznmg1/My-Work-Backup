<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Oneira: 2026 Daily Fortune</title>

    <!-- 1. Tailwind & Config -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    fontFamily: { sans: ["Manrope", "Noto Sans KR", "sans-serif"], serif: ["Tenor Sans", "Noto Serif KR", "serif"] },
                    colors: { background: "#150910", surface: "#230f19", primary: "#ff0084", "primary-dark": "#cc006a", "accent-pink": "#ce8dae", "cosmic-purple": "#8b5cf6", "cosmic-cyan": "#06b6d4" },
                    animation: { "pulse-slow": "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite", "spin-slow": "spin 12s linear infinite", "fade-in": "fadeIn 0.5s ease-out forwards" },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } },
                    backgroundImage: { 'noise': "url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMDI1Ii8+Cjwvc3ZnPg==')" }
                },
            },
        };
    </script>

    <!-- 2. Fonts & Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Tenor+Sans&family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- 3. React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"
        crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin></script>

    <!-- 4. Global CSS -->
    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 0, 132, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 0, 132, 0.5);
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
        }

        .glass-panel {
            background: rgba(35, 15, 25, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>

<body class="bg-background text-white antialiased overflow-hidden">
    <!-- Initial Loading Screen to prevent font flicker -->
    <div id="initial-loader"
        style="position:fixed;inset:0;z-index:9999;background:#150910;display:flex;align-items:center;justify-content:center;">
        <div style="text-align:center;opacity:0.5;">
            <div
                style="width:40px;height:40px;border:2px solid rgba(255,0,132,0.3);border-top-color:#ff0084;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;">
            </div>
        </div>
        <style>
            @keyframes spin {
                to {
                    transform: rotate(360deg)
                }
            }
        </style>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- ì˜êµ¬ ì €ì¥ì†Œ í—¬í¼ (Capacitor Preferences API) ---
        const Storage = {
            async get(key) {
                try {
                    if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                        const { Preferences } = await import('@capacitor/preferences');
                        const { value } = await Preferences.get({ key });
                        return value;
                    }
                } catch (e) { console.error('Storage get failed:', e); }
                return localStorage.getItem(key);
            },
            async set(key, value) {
                try {
                    if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                        const { Preferences } = await import('@capacitor/preferences');
                        await Preferences.set({ key, value });
                        return;
                    }
                } catch (e) { console.error('Storage set failed:', e); }
                localStorage.setItem(key, value);
            }
        };

        // --- CONSTANTS ---
        const ViewState = { SPLASH: 'SPLASH', SELECTION: 'SELECTION', USER_INFO: 'USER_INFO', INPUT_DREAM: 'INPUT_DREAM', LOADING: 'LOADING', RESULT: 'RESULT', HISTORY: 'HISTORY' };
        const FortuneType = { DREAM: 'DREAM', FORTUNE: 'FORTUNE', SOUL: 'SOUL' };

        // --- COMPONENTS ---

        const Background = () => (
            <div className="absolute inset-0 z-0 pointer-events-none overflow-hidden select-none">
                <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-primary/10 rounded-full blur-[120px]" />
                <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-cosmic-purple/10 rounded-full blur-[120px]" />
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-primary/5 rounded-full blur-[100px] opacity-40" />
                <div className="absolute inset-0 bg-noise opacity-20 mix-blend-overlay" />
            </div>
        );

        const Header = ({ title, showBack, onBack }) => (
            <div className="flex items-center justify-between p-6 z-30 relative">
                {showBack ? (
                    <button onClick={onBack} className="flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 transition-all group backdrop-blur-md">
                        <span className="material-symbols-outlined text-sm group-hover:-translate-x-1 transition-transform">arrow_back</span>
                        <span className="text-[10px] font-bold tracking-[0.2em] uppercase">ë’¤ë¡œê°€ê¸°</span>
                    </button>
                ) : <div className="w-24"></div>}

                {title && (
                    <h1 className="font-serif text-lg tracking-[0.2em] text-white/90 drop-shadow-lg uppercase text-center absolute left-1/2 -translate-x-1/2">
                        {title}
                    </h1>
                )}

                <div className="w-24"></div>
            </div>
        );

        const SplashView = ({ onEnter }) => (
            <div className="flex flex-col items-center justify-center h-full w-full space-y-16 animate-fade-in px-6">
                <div className="flex items-center justify-center gap-6 md:gap-10">
                    {/* í•´ëª½ ì•„ì´ì½˜ */}
                    <div className="flex flex-col items-center gap-2">
                        <div className="w-14 h-14 rounded-full bg-cosmic-purple/10 border border-cosmic-purple/30 flex items-center justify-center backdrop-blur-md">
                            <span className="text-2xl">ğŸŒ™</span>
                        </div>
                        <span className="text-[10px] text-white/50 tracking-wider">í•´ëª½</span>
                    </div>
                    {/* ë©”ì¸ ë²„íŠ¼ */}
                    <div onClick={onEnter} className="cursor-pointer group relative w-24 h-24 rounded-full bg-primary/10 border border-primary/30 flex items-center justify-center backdrop-blur-xl transition-all duration-500 hover:scale-110 hover:shadow-[0_0_50px_rgba(255,0,132,0.5)]">
                        <span className="text-5xl drop-shadow-[0_0_8px_rgba(255,0,132,0.8)] group-hover:rotate-12 transition-transform duration-500">âœ¨</span>
                        <div className="absolute inset-0 rounded-full border border-primary/30 animate-pulse-slow"></div>
                    </div>
                    {/* ìš´ì„¸ ì•„ì´ì½˜ */}
                    <div className="flex flex-col items-center gap-2">
                        <div className="w-14 h-14 rounded-full bg-cosmic-cyan/10 border border-cosmic-cyan/30 flex items-center justify-center backdrop-blur-md">
                            <span className="text-2xl">ğŸ”®</span>
                        </div>
                        <span className="text-[10px] text-white/50 tracking-wider">ìš´ì„¸</span>
                    </div>
                </div>

                <div className="flex flex-col items-center text-center space-y-6">
                    <h1 className="font-serif text-5xl font-normal leading-tight tracking-[0.2em] text-white drop-shadow-xl">
                        2026<br />DAILY<br />DESTINY
                    </h1>
                    <div className="w-px h-12 bg-gradient-to-b from-transparent via-primary/50 to-transparent"></div>
                </div>

                <button onClick={onEnter} className="mt-8 text-accent-pink text-xs font-bold tracking-[0.3em] uppercase opacity-70 hover:opacity-100 transition-opacity">
                    Tap the spark to begin
                </button>
            </div>
        );

        const SelectionView = ({ onSelect, onHistory, onProfile, userName }) => (
            <div className="flex flex-col h-full w-full animate-fade-in pb-24 font-serif">
                <div className="flex justify-end items-center px-6 pt-6 pb-2">
                    <button onClick={onProfile} className="text-xs text-white/50 border border-white/20 rounded-full px-3 py-1 hover:bg-white/10 transition-colors">
                        {userName ? `${userName}ë‹˜` : 'ì •ë³´ ìˆ˜ì •'}
                    </button>
                </div>
                <div className="flex-1 overflow-y-auto px-6 pt-2 pb-0">
                    <div className="flex flex-col mb-8 text-center">
                        <h1 className="text-3xl font-serif text-white leading-tight mb-2">
                            2026<br />
                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-primary to-cosmic-purple">DAILY DESTINY</span>
                        </h1>
                        <p className="text-white/60 text-sm font-medium">ìš´ëª…ì„ í™•ì¸í•  ê¸¸ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                    </div>

                    <div className="flex flex-col sm:flex-row justify-center items-stretch gap-3 w-full flex-1">
                        {/* 1. DREAM */}
                        <div onClick={() => onSelect(FortuneType.DREAM)} className="group relative flex-1 cursor-pointer transition-all duration-500 hover:flex-[1.2] hover:-translate-y-2">
                            <div className="relative h-full w-full rounded-[1.5rem] border border-cosmic-purple/50 bg-[#0a0510] shadow-[0_0_15px_rgba(139,92,246,0.1)] group-hover:shadow-[0_0_30px_rgba(139,92,246,0.4)] group-hover:border-cosmic-purple transition-all duration-300 overflow-hidden flex flex-col items-center justify-center">
                                <div className="absolute inset-0 bg-gradient-to-b from-transparent via-cosmic-purple/5 to-cosmic-purple/10 opacity-50"></div>
                                <div className="w-20 h-20 rounded-full border-2 border-cosmic-purple/80 shadow-[0_0_15px_rgba(139,92,246,0.5)] flex items-center justify-center bg-cosmic-purple/5 mb-4">
                                    <span className="material-symbols-outlined text-cosmic-purple text-4xl">mode_night</span>
                                </div>
                                <div className="text-center relative z-10">
                                    <p className="text-cosmic-purple text-xs font-bold tracking-[0.15em] uppercase">í•´ëª½</p>
                                    <p className="text-[9px] text-white/30 font-mono mt-1">THE MOON</p>
                                </div>
                            </div>
                        </div>

                        {/* 2. FORTUNE (ìš´ì„¸) */}
                        <div onClick={() => onSelect(FortuneType.FORTUNE)} className="group relative flex-1 cursor-pointer transition-all duration-500 hover:flex-[1.2] hover:-translate-y-2">
                            <div className="relative h-full w-full rounded-[1.5rem] border border-cosmic-cyan/50 bg-[#050a10] shadow-[0_0_15px_rgba(6,182,212,0.1)] group-hover:shadow-[0_0_30px_rgba(6,182,212,0.4)] group-hover:border-cosmic-cyan transition-all duration-300 overflow-hidden flex flex-col items-center justify-center">
                                <div className="absolute inset-0 bg-gradient-to-b from-transparent via-cosmic-cyan/5 to-cosmic-cyan/10 opacity-50"></div>
                                <div className="w-20 h-20 rounded-full border-2 border-cosmic-cyan/80 shadow-[0_0_15px_rgba(6,182,212,0.5)] flex items-center justify-center bg-cosmic-cyan/5 mb-4">
                                    <span className="material-symbols-outlined text-cosmic-cyan text-5xl">visibility</span>
                                </div>
                                <div className="text-center relative z-10">
                                    <p className="text-cosmic-cyan text-xs font-bold tracking-[0.15em] uppercase">ìš´ì„¸</p>
                                    <p className="text-[9px] text-white/30 font-mono mt-1">THE MAGICIAN</p>
                                </div>
                            </div>
                        </div>

                        {/* 3. SOUL (Added back) */}
                        <div onClick={() => onSelect(FortuneType.SOUL)} className="group relative flex-1 cursor-pointer transition-all duration-500 hover:flex-[1.2] hover:-translate-y-2">
                            <div className="relative h-full w-full rounded-[1.5rem] border border-primary/50 bg-[#10050a] shadow-[0_0_15px_rgba(255,0,132,0.1)] group-hover:shadow-[0_0_30px_rgba(255,0,132,0.4)] group-hover:border-primary transition-all duration-300 overflow-hidden flex flex-col items-center justify-center">
                                <div className="absolute inset-0 bg-gradient-to-b from-transparent via-primary/5 to-primary/10 opacity-50"></div>
                                <div className="flex items-center justify-center relative p-2 mb-4">
                                    <span className="material-symbols-outlined text-primary text-5xl drop-shadow-[0_0_8px_rgba(255,0,132,0.8)]">favorite</span>
                                </div>
                                <div className="text-center relative z-10">
                                    <div className="w-8 h-px bg-primary/50 mx-auto mb-3"></div>
                                    <p className="text-primary text-xs font-bold tracking-[0.15em] uppercase group-hover:text-white transition-colors">ì‹¬ë¦¬</p>
                                    <p className="text-[9px] text-white/30 font-mono mt-1">THE LOVERS</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* COLLECTION BUTTON (New) */}
                    <div className="mt-8 w-full flex justify-center">
                        <button onClick={onHistory} className="group flex items-center gap-3 px-8 py-4 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 hover:border-primary/50 transition-all">
                            <span className="material-symbols-outlined text-white/70 group-hover:text-primary transition-colors">collections</span>
                            <span className="text-sm font-serif font-bold tracking-widest text-white/90 group-hover:text-white">ë‚˜ì˜ ìˆ˜ì§‘í•¨</span>
                        </button>
                    </div>

                </div>
            </div>
        );

        const UserInfoView = ({ onNext, initialData }) => {
            const [name, setName] = useState(initialData?.name || "");
            const [birth, setBirth] = useState(initialData?.birth || "");
            const [gender, setGender] = useState(initialData?.gender || "");

            const isFormValid = name.trim().length > 0 && birth.length === 8 && gender !== "";

            const handleNext = () => {
                if (isFormValid) {
                    onNext({ name, birth, gender });
                }
            };

            return (
                <div className="flex flex-col h-full w-full animate-fade-in relative z-20 font-serif pb-safe">
                    {/* Empty Header Area for spacing */}
                    <div className="flex items-center justify-between p-6 z-30 relative min-h-[88px]">
                        <div className="w-24"></div>
                        <div className="w-24"></div>
                    </div>

                    <div className="px-6 pb-6 text-center">
                        <h2 className="text-2xl font-serif text-white mb-2">ë‹¹ì‹ ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”</h2>
                        <p className="text-white/50 text-xs">ìš´ëª…ì„ ì½ê¸° ìœ„í•œ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    </div>

                    <div className="flex-1 px-8 space-y-8 overflow-y-auto">
                        <div className="space-y-4">
                            <label className="block text-accent-pink text-xs font-bold tracking-widest uppercase ml-1">ì´ë¦„</label>
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                                className="w-full bg-transparent border-b border-white/20 py-3 text-xl text-white outline-none focus:border-primary transition-colors placeholder:text-white/20"
                            />
                        </div>

                        <div className="space-y-4">
                            <label className="block text-accent-pink text-xs font-bold tracking-widest uppercase ml-1">ìƒë…„ì›”ì¼ (8ìë¦¬)</label>
                            <input
                                type="text"
                                value={birth}
                                onChange={(e) => setBirth(e.target.value.replace(/[^0-9]/g, '').slice(0, 8))}
                                placeholder="YYYYMMDD (ì˜ˆ: 19900101)"
                                className="w-full bg-transparent border-b border-white/20 py-3 text-xl text-white outline-none focus:border-primary transition-colors placeholder:text-white/20 tracking-wider"
                            />
                        </div>

                        <div className="space-y-4">
                            <label className="block text-accent-pink text-xs font-bold tracking-widest uppercase ml-1">ì„±ë³„</label>
                            <div className="flex gap-4">
                                {['ë‚¨ì„±', 'ì—¬ì„±', 'ë¹„ê³µê°œ'].map((g) => (
                                    <button
                                        key={g}
                                        onClick={() => setGender(g)}
                                        className={`flex-1 py-3 rounded-lg border text-sm font-medium transition-all ${gender === g
                                            ? 'bg-primary/20 border-primary text-white shadow-[0_0_15px_rgba(255,0,132,0.3)]'
                                            : 'border-white/10 text-white/40 hover:bg-white/5'
                                            }`}
                                    >
                                        {g}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="p-8 pb-10">
                        <button
                            onClick={handleNext}
                            disabled={!isFormValid}
                            className="w-full rounded-full h-14 bg-white/10 hover:bg-white/20 disabled:opacity-30 text-white font-bold tracking-[0.1em] border border-white/20 transition-all flex items-center justify-center gap-2"
                        >
                            <span>ê³„ì†í•˜ê¸°</span>
                            <span className="material-symbols-outlined">arrow_forward</span>
                        </button>
                    </div>
                </div >
            )
        };

        const HistoryView = ({ history, onBack, onSelect }) => (
            <div className="flex flex-col h-full w-full animate-fade-in pb-24">
                <Header title="" showBack onBack={onBack} />
                <div className="px-6 pt-2 pb-6 flex-1 overflow-y-auto">
                    <div className="mb-6">
                        <h2 className="text-white text-3xl font-serif font-bold leading-tight">Your Path</h2>
                        <p className="text-accent-pink text-sm font-normal opacity-80">Fragments of your destiny.</p>
                    </div>

                    {history.length === 0 ? (
                        <div className="flex flex-col items-center justify-center h-64 opacity-50 border border-dashed border-white/20 rounded-2xl">
                            <span className="material-symbols-outlined text-4xl mb-2">auto_awesome_mosaic</span>
                            <p className="text-sm">ì•„ì§ ìˆ˜ì§‘ëœ ìš´ì„¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-4">
                            {history.map((item, i) => (
                                <div key={i} onClick={() => onSelect(item)} className="group relative flex flex-col bg-[#2e1423] rounded-[2rem] p-3 border border-white/5 overflow-hidden hover:border-primary/50 transition-all cursor-pointer">
                                    {/* Image Thumbnail */}
                                    <div className="aspect-[2/3] w-full rounded-2xl bg-black mb-3 overflow-hidden relative">
                                        <img
                                            src={item.imageUrl}
                                            className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                                            alt="Fortune"
                                            onError={(e) => {
                                                const currentSrc = e.currentTarget.src;

                                                // Tier 1 Failure -> Try Tier 2
                                                if (currentSrc.includes('pollinations') && !currentSrc.includes('retry=true')) {
                                                    e.currentTarget.src = `https://image.pollinations.ai/prompt/manhwa%20style%20tarot,%20vibrant%20colors,%20webtoon?width=800&height=1200&model=flux&seed=${item.id}&retry=true`;
                                                    return;
                                                }

                                                // Tier 2 Failure -> Try Tier 3 (DiceBear)
                                                if (currentSrc.includes('pollinations') && currentSrc.includes('retry=true')) {
                                                    e.currentTarget.src = `https://api.dicebear.com/9.x/notionists/svg?seed=${item.id}&backgroundColor=2e1423`;
                                                }
                                            }}
                                        />
                                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                        <div className="absolute bottom-2 left-2 flex items-center gap-1">
                                            <span className="material-symbols-outlined text-white text-sm">{item.icon}</span>
                                            <span className="text-[10px] text-white/80 font-bold">{item.title}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <p className="text-accent-pink text-[10px] font-medium uppercase tracking-wider mb-1">{item.date}</p>
                                        <p className="text-white/60 text-xs line-clamp-2">{item.description.split('\n')[0]}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );

        const InputDreamView = ({ onBack, onSubmit, type }) => {
            const [text, setText] = useState("");

            let title = "";
            let placeholder = "";

            switch (type) {
                case FortuneType.DREAM:
                    title = "ì–´ë–¤ ê¿ˆì„ ê¾¸ì…¨ë‚˜ìš”?";
                    placeholder = "ê¿ˆì—ì„œ ë³¸ ì¥ë©´, ëŠê¼ˆë˜ ê°ì •, ê¸°ì–µë‚˜ëŠ” ì‚¬ë¬¼ë“¤ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”...\n(ì˜ˆ: ë†’ì€ ê³³ì—ì„œ ë–¨ì–´ì§€ëŠ” ê¿ˆì„ ê¿¨ëŠ”ë° ë¬´ì„­ì§€ ì•Šê³  ì‹œì›í–ˆì–´ìš”)";
                    break;
                case FortuneType.FORTUNE:
                    title = "ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?";
                    placeholder = "ì—°ì• , ì§ì¥, ê¸ˆì „ ë“±ì˜ ê³ ë¯¼ì´ë‚˜ ì˜¤ëŠ˜ì˜ ìš´ì„¸ê°€ ê¶ê¸ˆí•˜ë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”...\n(ì˜ˆ: ìš”ì¦˜ ì—°ì• ìš´ì´ ê¶ê¸ˆí•´ìš” / ì´ë²ˆ ë‹¬ ì§ì¥ìš´ì´ ì–´ë–¨ê¹Œìš”? / ì˜¤ëŠ˜ í•˜ë£¨ ìš´ì„¸ ì•Œë ¤ì£¼ì„¸ìš”)";
                    break;
                case FortuneType.SOUL:
                    title = "ë§ˆìŒì´ ì–´ë– ì‹ ê°€ìš”?";
                    placeholder = "ì§€ê¸ˆ ëŠë¼ëŠ” ê°ì •ì´ë‚˜, ëˆ„êµ¬ì—ê²Œë„ ë§í•˜ì§€ ëª»í•œ ì†ë§ˆìŒì„ í„¸ì–´ë†“ì•„ ë³´ì„¸ìš”...\n(ì˜ˆ: ìš”ì¦˜ ì´ìœ  ì—†ì´ ë¶ˆì•ˆí•˜ê³  ì ì´ ì˜ ì˜¤ì§€ ì•Šì•„ìš”. ì œ ë§ˆìŒì˜ ì›ì¸ì´ ë­˜ê¹Œìš”?)";
                    break;
                default:
                    title = "ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?";
                    placeholder = "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”...";
            }

            return (
                <div className="flex flex-col h-full w-full animate-fade-in relative z-20 font-serif">
                    <Header title="" showBack onBack={onBack} />
                    <div className="flex-1 flex flex-col px-8 overflow-y-auto">
                        <div className="pt-4 pb-6">
                            <h2 className="font-serif text-white tracking-wide text-3xl font-normal leading-tight text-left">
                                {title}
                            </h2>
                        </div>
                        <div className="flex-1 flex flex-col pb-[120px]">
                            <textarea
                                autoFocus
                                value={text}
                                onChange={(e) => setText(e.target.value)}
                                className="w-full h-full min-h-[300px] bg-transparent border-none text-[22px] text-white/90 font-serif placeholder:text-accent-pink/40 leading-relaxed outline-none resize-none"
                                placeholder={placeholder}
                            />
                        </div>
                    </div>
                    <div className="absolute bottom-0 left-0 w-full p-8 bg-gradient-to-t from-background via-background to-transparent z-20">
                        <button onClick={() => onSubmit(text)} disabled={!text.trim()} className="w-full rounded-full h-14 bg-primary hover:bg-primary-dark disabled:opacity-50 text-white font-bold tracking-[0.05em] shadow-[0_0_25px_rgba(255,0,132,0.25)] flex items-center justify-center gap-3 transition-all">
                            <span className="material-symbols-outlined text-[20px] animate-pulse-slow">auto_awesome</span>
                            <span>ê²°ê³¼ ë³´ê¸°</span>
                        </button>
                    </div>
                </div>
            );
        };

        const LoadingView = () => (
            <div className="flex flex-col items-center justify-center h-full w-full z-50 bg-background/80 backdrop-blur-xl">
                <div className="relative size-24 flex items-center justify-center">
                    <div className="absolute inset-0 rounded-full border-2 border-primary/20"></div>
                    <div className="absolute inset-0 rounded-full border-t-2 border-primary animate-spin"></div>
                    <span className="material-symbols-outlined text-4xl text-primary animate-pulse">auto_awesome</span>
                </div>
                <p className="mt-8 text-white/60 font-serif tracking-widest text-sm animate-pulse">ë³„ë“¤ì˜ ì´ì•¼ê¸°ë¥¼ ì½ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        );

        const ResultView = ({ result, onAccept }) => {
            if (!result) return null;

            // Clean Description: Remove the "4. ..." part
            let cleanDescription = result.description;
            const splitMatch = result.description.match(/4\.\s*(?:\*\*|\[)?\s*ì´ë¯¸ì§€/i);
            if (splitMatch) {
                cleanDescription = result.description.substring(0, splitMatch.index).trim();
            }

            return (
                <div className="flex flex-col items-center h-full w-full z-40 bg-background relative overflow-hidden animate-fade-in px-6 text-center">
                    {/* Background Blur Effect */}
                    <div className="absolute inset-0 z-0 bg-cover bg-center opacity-30 blur-xl scale-110 transition-opacity duration-1000" style={{ backgroundImage: `url('${result.imageUrl}')` }}></div>
                    <div className="absolute inset-0 z-0 bg-gradient-to-b from-background/90 via-background/95 to-background"></div>

                    <div className="relative z-10 flex flex-col items-center w-full max-w-lg overflow-y-auto max-h-screen py-10 no-scrollbar">

                        {/* THE DRAWN IMAGE (Central Hero) with Loading State */}
                        <div className="group relative mb-8 flex flex-col items-center justify-center shrink-0">
                            <div className="relative w-64 h-96 rounded-2xl overflow-hidden border border-white/20 shadow-[0_0_50px_rgba(139,92,246,0.25)] group-hover:shadow-[0_0_80px_rgba(255,0,132,0.4)] transition-all duration-700 bg-black flex items-center justify-center">
                                {/* Always show spinner if image hasn't loaded */}
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <span className="material-symbols-outlined text-4xl text-white/20 animate-spin">progress_activity</span>
                                </div>

                                <img
                                    src={result.imageUrl} alt="Destiny Card"
                                    className="relative w-full h-full object-cover z-10"
                                    style={{ minHeight: '100%' }}
                                    loading="eager"
                                    onError={(e) => {
                                        const currentSrc = e.currentTarget.src;

                                        // Tier 1 Failure -> Try Tier 2 (Pollinations Retry with simpler prompt but still COLOR)
                                        if (currentSrc.includes('pollinations') && !currentSrc.includes('retry=true')) {
                                            console.warn("Pollinations Tier 1 failed, switching to Tier 2 (Full Color Retry)");
                                            // Retry with simple but COLORFUL prompt
                                            e.currentTarget.src = `https://image.pollinations.ai/prompt/manhwa%20style%20tarot,%20vibrant%20colors,%20webtoon,%20masterpiece?width=800&height=1200&model=flux&seed=${Math.random()}&retry=true`;
                                            return;
                                        }

                                        // Tier 2 Failure -> Try Tier 3 (DiceBear 'Notionists' - Guaranteed & Stylish)
                                        if (currentSrc.includes('pollinations') && currentSrc.includes('retry=true')) {
                                            console.warn("Pollinations Tier 2 failed, switching to DiceBear Fallback");
                                            // 'Notionists' style is very clean, comic-like, and fits the aesthetic
                                            // Use result.id to match HistoryView
                                            e.currentTarget.src = `https://api.dicebear.com/9.x/notionists/svg?seed=${result.id}&backgroundColor=2e1423`;
                                        }
                                    }}
                                />

                                {/* Shine effect */}
                                <div className="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none z-20"></div>
                            </div>
                            <p className="mt-4 text-[10px] text-white/40 tracking-[0.3em] font-serif uppercase animate-pulse">Your Vision</p>
                        </div>

                        <div className="mb-8 flex flex-col items-center gap-2 shrink-0">
                            <h2 className="text-sm font-bold tracking-[0.2em] text-white/60 uppercase">DESTINY REVEALED</h2>
                            <h1 className="font-serif text-5xl font-normal tracking-wider text-white drop-shadow-xl uppercase">{result.title}</h1>
                        </div>

                        <div className="mb-14 px-4 shrink-0">
                            <p className="text-lg font-light leading-relaxed text-white/80 antialiased font-serif whitespace-pre-wrap">
                                {cleanDescription}
                            </p>
                        </div>

                        <button onClick={onAccept} className="group relative flex min-w-[200px] items-center justify-center overflow-hidden rounded-full border border-white/30 bg-white/5 px-8 py-4 transition-all duration-300 hover:border-primary hover:bg-primary/20 hover:shadow-[0_0_20px_rgba(255,0,132,0.4)] active:scale-95 shrink-0 backdrop-blur-md">
                            <span className="font-bold tracking-[0.15em] text-white">í™•ì¸</span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState(ViewState.SPLASH);
            const [selectedType, setSelectedType] = useState(null);
            const [userInfo, setUserInfo] = useState(null);
            const [result, setResult] = useState(null);
            const [history, setHistory] = useState([]);
            const [lastFortuneDate, setLastFortuneDate] = useState('');
            const [isLoading, setIsLoading] = useState(true);

            // ì•± ì‹œì‘ ì‹œ ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const [savedUserInfo, savedHistory, savedDate] = await Promise.all([
                            Storage.get('oneira_user_info'),
                            Storage.get('dream_history'),
                            Storage.get('last_fortune_date')
                        ]);
                        if (savedUserInfo) setUserInfo(JSON.parse(savedUserInfo));
                        if (savedHistory) setHistory(JSON.parse(savedHistory));
                        if (savedDate) setLastFortuneDate(savedDate);
                    } catch (e) { console.error('Data load failed:', e); }
                    setIsLoading(false);
                };
                loadData();
            }, []);

            // userInfo ë³€ê²½ ì‹œ ì €ì¥
            useEffect(() => {
                if (userInfo) Storage.set('oneira_user_info', JSON.stringify(userInfo));
            }, [userInfo]);

            // history ë³€ê²½ ì‹œ ì €ì¥
            useEffect(() => {
                if (history.length > 0) Storage.set('dream_history', JSON.stringify(history));
            }, [history]);

            const showRewardedAd = async () => {
                if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                    try {
                        const { AdMob } = await import('@capacitor-community/admob');
                        await AdMob.prepareRewardVideoAd({
                            adId: 'ca-app-pub-9625149267611159/5587558816',
                        });
                        const reward = await AdMob.showRewardVideoAd();
                        return !!reward;
                    } catch (e) {
                        console.error('Ad failed:', e);
                        // If ad fails to load, maybe let them see it anyway to not block user exp?
                        // Or just return false. Let's return true if it's a test environment or fallback.
                        return true;
                    }
                }
                return true; // Browser fallback
            };

            const processFortune = async (type, context) => {
                const today = new Date().toLocaleDateString();

                // If they already saw a fortune today, ask for an ad
                if (lastFortuneDate === today) {
                    const confirmed = window.confirm("ì˜¤ëŠ˜ì˜ ë¬´ë£Œ ìš´ì„¸ë¥¼ ì´ë¯¸ ë³´ì…¨ìŠµë‹ˆë‹¤. ê´‘ê³ ë¥¼ ì‹œì²­í•˜ê³  í•œ ë²ˆ ë” í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                    if (!confirmed) return;

                    setView(ViewState.LOADING); // Show loading while ad prepares
                    const success = await showRewardedAd();
                    if (!success) {
                        alert("ê´‘ê³  ì‹œì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        setView(ViewState.SELECTION);
                        return;
                    }
                }

                setView(ViewState.LOADING);
                setLastFortuneDate(today);
                Storage.set('last_fortune_date', today);
                try {
                    // ëª¨ë“œ ì´ë¦„ì„ í•œê¸€ë¡œ ë³€í™˜
                    const modeNames = { DREAM: 'í•´ëª½', FORTUNE: 'ìš´ì„¸', SOUL: 'ì‹¬ë¦¬ìƒë‹´' };
                    const modeName = modeNames[type] || 'ìš´ì„¸';

                    // Construct enhanced context with mode info and STRICT negative constraints
                    const userContextStr = `[ëª¨ë“œ: ${modeName}] ì‚¬ìš©ì ì´ë¦„: ${userInfo?.name || 'ë¯¸ì§€ì •'}, ìƒë…„ì›”ì¼: ${userInfo?.birth || 'ë¯¸ì§€ì •'}, ì„±ë³„: ${userInfo?.gender || 'ë¯¸ì§€ì •'}. [SYSTEM INSTRUCTION: DO NOT use phrases like '30ë…„ ê²½ë ¥', 'ì „ë¬¸ê°€', 'ë² í…Œë‘' or introduction. Just give the interpretation directly. Do NOT mention the mode name in your response.]`;

                    const res = await fetch('https://dream-fortune-ai.onrender.com/analyze_dream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: context, user_context: userContextStr })
                    });
                    if (res.ok) {
                        const data = await res.json();

                        // Parse Image Prompt for URL generation
                        const promptRegex = /4\.\s*(?:\*\*|\[)?\s*(?:ì´ë¯¸ì§€\s*í”„ë¡¬í”„íŠ¸|Image\s*Prompt)\s*(?:\*\*|\])?\s*:?\s*(.*)/i;
                        const promptMatch = data.interpretation.match(promptRegex);
                        let imagePrompt = promptMatch ? promptMatch[1].trim() : "Mystic tarot card, ethereal light";
                        if (imagePrompt.length > 150) imagePrompt = imagePrompt.substring(0, 150);
                        // Force High-Quality Manhwa/Webtoon Style
                        const styleTags = ", manhwa style, webtoon, anime art, masterpiece, 8k, vibrant colors, dramatic lighting, highly detailed, cinematic composition";
                        const finalPrompt = imagePrompt + styleTags;
                        // UPGRADE: Using 'flux' model for superior prompt adherence and detail.
                        const generatedImageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?width=800&height=1200&seed=${Math.random()}&nologo=true&model=flux`;

                        // Cache Image Logic
                        let finalUrl = generatedImageUrl;
                        const resultId = Date.now();

                        try {
                            const cacheRes = await fetch('https://dream-fortune-ai.onrender.com/cache_image', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: generatedImageUrl, id: resultId.toString() })
                            });
                            if (cacheRes.ok) {
                                const cacheData = await cacheRes.json();
                                if (cacheData.success) {
                                    finalUrl = cacheData.local_url;
                                    console.log("Image cached locally:", finalUrl);
                                }
                            }
                        } catch (err) {
                            console.warn("Image caching failed, using remote URL:", err);
                        }

                        const newResult = {
                            id: resultId,
                            title: data.luck_score.toString(),
                            description: data.interpretation,
                            icon: type === FortuneType.DREAM ? 'mode_night' : type === FortuneType.FORTUNE ? 'visibility' : 'favorite',
                            date: new Date().toLocaleDateString(),
                            imageUrl: finalUrl
                        };
                        setResult(newResult);
                        setHistory(prev => [newResult, ...prev]);
                    } else throw new Error();
                } catch {
                    const fallbackUrl = "https://image.pollinations.ai/prompt/Comic%20book%20scene,%20action%20shot,%20vibrant%20colors?width=800&height=1200&nologo=true&model=turbo";
                    const fallback = {
                        id: Date.now(),
                        title: "88",
                        description: "1. ìš”ì•½\nìš°ì£¼ëŠ” ë‹¹ì‹ ì˜ í¸ì…ë‹ˆë‹¤.\n\n2. ì‹¬ì¸µ\nì ì‹œ ì‰¬ì–´ê°€ëŠ” ì‹œê°„ì…ë‹ˆë‹¤.\n\n3. ì¡°ì–¸\në§ˆìŒì˜ í‰í™”ë¥¼ ì°¾ìœ¼ì„¸ìš”.\n\n4. [ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸]: Mystical Fog",
                        icon: 'error',
                        date: new Date().toLocaleDateString(),
                        imageUrl: fallbackUrl
                    };
                    setResult(fallback);
                    setHistory(prev => [fallback, ...prev]);
                }
                setView(ViewState.RESULT);
            };

            return (
                <div className="relative w-full h-screen bg-background text-white flex justify-center overflow-hidden">
                    <Background />
                    <div className="relative w-full max-w-[600px] h-full bg-background/50 backdrop-blur-sm shadow-2xl border-x border-white/5 overflow-hidden flex flex-col">
                        {view === ViewState.SPLASH && <SplashView onEnter={() => setView(ViewState.USER_INFO)} />}

                        {view === ViewState.USER_INFO && <UserInfoView
                            initialData={userInfo}
                            onBack={() => setView(ViewState.SPLASH)}
                            onNext={(data) => { setUserInfo(data); setView(ViewState.SELECTION); }}
                        />}

                        {view === ViewState.SELECTION && <SelectionView
                            userName={userInfo?.name}
                            onProfile={() => setView(ViewState.USER_INFO)}
                            onSelect={(t) => { setSelectedType(t); setView(ViewState.INPUT_DREAM); }}
                            onHistory={() => setView(ViewState.HISTORY)}
                        />}

                        {view === ViewState.INPUT_DREAM && <InputDreamView
                            type={selectedType}
                            onBack={() => setView(ViewState.SELECTION)}
                            onSubmit={(txt) => processFortune(selectedType, txt)}
                        />}

                        {view === ViewState.LOADING && <LoadingView />}

                        {view === ViewState.RESULT && <ResultView result={result} onAccept={() => setView(ViewState.HISTORY)} />}

                        {view === ViewState.HISTORY && <HistoryView
                            history={history}
                            onBack={() => setView(ViewState.SELECTION)}
                            onSelect={(savedItem) => { setResult(savedItem); setView(ViewState.RESULT); }}
                        />}
                    </div>
                </div>
            );
        };

        // Hide initial loader after fonts load
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

        // Remove loader after a short delay to allow fonts to settle
        setTimeout(() => {
            const loader = document.getElementById('initial-loader');
            if (loader) loader.style.display = 'none';
        }, 600);

        // --- AdMob Integration ---
        // Capacitor AdMobì„ ë™ì ìœ¼ë¡œ ë¡œë“œ (ì•± í™˜ê²½ì—ì„œë§Œ ë™ì‘)
        (async function initAdMob() {
            try {
                // Capacitor Plugins ì²´í¬
                if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                    const { AdMob, BannerAdSize, BannerAdPosition } = await import('@capacitor-community/admob');

                    // AdMob ì´ˆê¸°í™”
                    await AdMob.initialize({
                        requestTrackingAuthorization: true,
                        testingDevices: [],
                        initializeForTesting: false
                    });
                    console.log('AdMob initialized successfully');

                    // ë°°ë„ˆ ê´‘ê³  í‘œì‹œ (í•˜ë‹¨ì— ê³ ì •)
                    await AdMob.showBanner({
                        adId: 'ca-app-pub-9625149267611159/8529318868',
                        adSize: BannerAdSize.ADAPTIVE_BANNER,
                        position: BannerAdPosition.BOTTOM_CENTER,
                        margin: 0,
                        isTesting: false
                    });
                    console.log('Banner ad displayed');
                } else {
                    console.log('AdMob skipped: Not running in native app environment');
                }
            } catch (error) {
                console.error('AdMob initialization failed:', error);
            }
        })();
    </script>
</body>

</html>